name: CI Pipeline

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system dependencies for OpenCV
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0

    - name: Check code formatting with Black
      run: |
        black --check --diff gesture_controller/ tests/

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff gesture_controller/ tests/

    - name: Lint with flake8
      run: |
        flake8 gesture_controller/ tests/ --count --show-source --statistics

    - name: Lint with pylint
      run: |
        pylint gesture_controller/ --exit-zero

    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=gesture_controller --cov-report=term-missing --cov-report=xml

    - name: Upload coverage reports
      if: matrix.python-version == '3.12'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  readme-validation:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate README exists
      run: |
        if [ ! -f "README.md" ]; then
          echo "README.md not found!"
          exit 1
        fi
        echo "README.md found"

    - name: Check README content
      run: |
        # Check for required sections
        required_sections=("Installation" "Usage" "Features")
        for section in "${required_sections[@]}"; do
          if ! grep -qi "$section" README.md; then
            echo "Missing required section: $section"
            exit 1
          fi
        done
        echo "All required sections found in README"

    - name: Validate README length
      run: |
        lines=$(wc -l < README.md)
        if [ $lines -lt 50 ]; then
          echo "README.md is too short (less than 50 lines)"
          exit 1
        fi
        echo "README.md has adequate length: $lines lines"

  syntax-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Check Python syntax
      run: |
        python -m py_compile gesture_controller/*.py
        python -m py_compile tests/test_*.py

    - name: Check for common issues
      run: |
        # Check for print statements in production code (warnings only)
        echo "Checking for debug print statements..."
        grep -rn "print(" gesture_controller/ || echo "No print statements found (good!)"

  security-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Check dependencies for known vulnerabilities
      run: |
        safety check --json || echo "Safety check completed"

    - name: Run security linter (Bandit)
      run: |
        bandit -r gesture_controller/ -ll || echo "Bandit check completed"
